# SSH 접속 기능 개발 단계 및 테스트 계획

이 문서는 DuckPrompt 애플리케이션에 SSH 접속 기능을 추가하기 위한 개발 단계를 정의합니다. 개발은 총 3단계로 나누어 진행하며, 각 단계별 개발 내용과 테스트 방안을 명시합니다. 모든 단계에서 기능 구현과 함께 `pytest`를 사용한 테스트 코드 작성이 필수입니다.

## 1단계: SSH 설정 관리 백엔드 및 UI 구현

### 개발 내용

1. **SSH 라이브러리 선정 및 추가:**

   - SSH 연결 및 파일 전송(SFTP)을 위한 Python 라이브러리 선정 (예: `paramiko`, `asyncssh`).
   - GUI 애플리케이션의 특성을 고려하여, 동기 라이브러리(`paramiko`) 사용 시 UI 블로킹을 방지하기 위해 `QThread`를 활용한 백그라운드 실행 방안 마련. 비동기 라이브러리(`asyncssh`) 사용 시 `asyncqt` 또는 `qtrio` 등을 이용한 비동기 처리 통합 방안 고려. (초기에는 `paramiko` + `QThread` 접근이 기존 구조와 통합하기 용이할 수 있음)
   - 선정된 라이브러리를 `pyproject.toml`의 `dependencies`에 추가 (`uv pip install <library_name>`).

2. **SSH 접속 정보 모델 정의:**

   - `Pydantic` 모델을 사용하여 SSH 접속 정보(별칭, 호스트 주소, 포트, 사용자명, 인증 방식(비밀번호/키 파일), 비밀번호 또는 키 파일 경로 등)를 정의 (`src/core/pydantic_models/ssh_config.py` 등).
   - 비밀번호나 키 파일 내용은 민감 정보이므로, 저장 및 처리 시 보안 고려 (예: 암호화 저장, SSH Agent 활용 등).

3. **데이터베이스 스키마 확장:**

   - `src/utils/postgres_db_initializer.py` 스크립트 수정하여 SSH 접속 정보를 저장할 새로운 테이블(`ssh_connections` 등) 정의.
   - 테이블에는 접속 정보 모델의 필드와 생성/수정 타임스탬프 포함. 비밀번호/키 정보 저장 방식 결정.

4. **DB 서비스 확장 (`DbService`):**

   - `src/core/services/db_service.py`에 SSH 접속 정보 CRUD(Create, Read, Update, Delete)를 위한 메서드 추가.
   - 비밀번호/키 정보 저장/로드 시 암호화/복호화 로직 포함 (필요시).

5. **SSH 설정 관리 서비스 (`SshConfigService` - 신규):**

   - `DbService`를 사용하여 SSH 설정을 관리하는 서비스 클래스 구현 (`src/core/services/ssh_config_service.py`).
   - SSH 설정 목록 조회, 추가, 수정, 삭제 기능 제공.

6. **환경 설정 다이얼로그 UI 확장 (`SettingsDialog`):**

   - `src/ui/settings_dialog.py` 수정하여 SSH 설정 관리 섹션 추가.
   - `QListWidget` 또는 `QTableWidget`을 사용하여 저장된 SSH 연결 목록 표시.
   - 추가, 수정, 삭제 버튼 및 관련 입력 폼(호스트, 포트, 사용자명, 인증 방식 선택 등) 구현.
   - 키 파일 선택을 위한 `QFileDialog` 연동.
   - UI 동작과 `SshConfigService` 연동.

7. **SSH 연결 테스트 기능:**
   - 환경 설정 다이얼로그 내에서 선택된 SSH 설정으로 실제 연결을 테스트하는 기능 추가 (백그라운드 스레드에서 실행).
   - 연결 성공/실패 여부를 사용자에게 피드백.

### 테스트 내용

1. **DB 스키마 테스트:**

   - `postgres_db_initializer.py` 실행 시 `ssh_connections` 테이블이 정상적으로 생성되는지 확인.
   - 필드 타입, 제약 조건 등이 의도대로 설정되었는지 확인.

2. **DB 서비스 메서드 테스트 (`pytest`):**

   - `DbService`에 추가된 SSH 설정 CRUD 메서드에 대한 단위 테스트 작성.
   - 테스트용 DB 또는 Mock 객체를 사용하여 각 기능(추가, 조회, 수정, 삭제)의 정확성 검증.
   - 암호화/복호화 로직 테스트 (구현 시).

3. **SSH 설정 관리 서비스 테스트 (`pytest`):**

   - `SshConfigService`의 각 메서드에 대한 단위 테스트 작성.
   - Mock `DbService`를 주입하여 서비스 로직 검증.

4. **SSH 연결 로직 테스트 (`pytest`):**

   - 실제 SSH 서버 또는 Mock SSH 서버(`pytest-mock-server` 등 활용)를 대상으로 연결 테스트 함수 작성.
   - 다양한 인증 방식(비밀번호, 키 파일) 테스트.
   - 연결 실패 시 예외 처리 및 오류 메시지 검증.
   - `QThread` 사용 시 스레드 동작 및 완료/오류 시그널 처리 검증.

5. **환경 설정 다이얼로그 UI 테스트 (수동/자동):**
   - SSH 설정 목록이 DB 내용과 일치하게 표시되는지 확인.
   - 추가/수정/삭제 UI가 정상 동작하고 DB에 반영되는지 확인.
   - 입력 유효성 검사(필수 필드, 포트 번호 범위 등) 확인.
   - 연결 테스트 기능이 백그라운드에서 동작하고 결과를 올바르게 표시하는지 확인.
   - (선택적) `pytest-qt`를 이용한 UI 자동화 테스트 작성.

## 2단계: 메인 윈도우 SSH 연결 UI 및 로직 구현

### 개발 내용

1. **메인 윈도우 UI 수정 (`MainWindow`):**

   - `src/ui/main_window_setup_ui.py` 수정하여 상단 영역(또는 다른 적절한 위치)에 SSH 연결 선택 `QComboBox`와 연결/해제 `QPushButton` 추가.
   - 프로젝트 폴더 선택 버튼 옆 또는 관련 영역에 배치 고려.
   - SSH 연결 상태를 표시할 `QLabel` 추가 (예: "SSH 연결: 미연결" / "SSH 연결: user@host").

2. **SSH 연결 관리 로직 (`MainController` 또는 신규 `SshController`):**

   - `SshConfigService`를 통해 저장된 SSH 설정 목록을 불러와 `QComboBox`에 채우는 로직 구현.
   - 연결 버튼 클릭 시 선택된 설정으로 SSH 연결 시도 (백그라운드 스레드에서 실행).
     - 연결 성공 시:
       - SSH 클라이언트 인스턴스 저장 (예: `paramiko.SSHClient`, `paramiko.SFTPClient`).
       - 연결 상태 레이블 업데이트.
       - 연결 버튼을 "연결 해제"로 변경.
       - 파일 트리 뷰가 원격 경로를 표시하도록 준비 (3단계에서 구현).
       - 프로젝트 폴더 선택 로직 비활성화 또는 원격 경로 표시로 변경.
     - 연결 실패 시:
       - 사용자에게 오류 메시지 표시 (`QMessageBox`).
       - 연결 상태 레이블 업데이트.
   - 연결 해제 버튼 클릭 시:
     - SSH 연결 종료.
     - SSH 클라이언트 인스턴스 정리.
     - 연결 상태 레이블 및 버튼 상태 복원.
     - 파일 트리 뷰를 로컬 모드로 복원 (3단계에서 구현).
     - 프로젝트 폴더 선택 로직 활성화.
   - 애플리케이션 종료 시 SSH 연결 자동 해제 로직 추가 (`MainWindow.closeEvent`).

3. **SSH 클라이언트 관리:**
   - 연결된 SSH 클라이언트(`SSHClient`, `SFTPClient`) 인스턴스를 관리하는 방식 정의 (예: `MainWindow` 또는 전용 컨트롤러 내 멤버 변수).
   - 연결 유지 및 재연결 로직 고려 (선택 사항).

### 테스트 내용

1. **메인 윈도우 UI 테스트 (수동/자동):**

   - SSH 연결 드롭다운이 DB의 설정 목록으로 올바르게 채워지는지 확인.
   - 연결/해제 버튼 클릭 시 UI 상태(버튼 텍스트, 상태 레이블)가 올바르게 변경되는지 확인.
   - 연결 시도 중 UI가 블로킹되지 않는지 확인 (백그라운드 스레드 동작 검증).
   - 연결 성공/실패 시 적절한 피드백(메시지 박스, 상태 레이블)이 표시되는지 확인.
   - (선택적) `pytest-qt`를 이용한 UI 자동화 테스트 작성.

2. **SSH 연결/해제 로직 테스트 (`pytest`):**

   - 연결/해제 로직 함수에 대한 단위/통합 테스트 작성.
   - Mock SSH 서버 또는 실제 테스트 서버를 사용하여 연결/해제 동작 검증.
   - SSH 클라이언트 인스턴스가 올바르게 생성되고 정리되는지 확인.
   - 오류 발생 시 예외 처리 및 상태 복원 로직 검증.

3. **애플리케이션 종료 테스트:**
   - SSH 연결된 상태에서 애플리케이션 종료 시 연결이 정상적으로 해제되는지 확인 (로그 또는 시스템 리소스 확인).

## 3단계: 원격 파일 시스템 연동 및 기능 수정

### 개발 내용

1. **파일 시스템 모델 수정 (`FilteredFileSystemModel`, `CheckableProxyModel`):**

   - 현재 로컬 파일 시스템(`os` 모듈)에 의존적인 부분을 분리.
   - SSH 연결 상태에 따라 SFTP 클라이언트를 사용하여 원격 디렉토리 목록 조회, 파일 정보(이름, 크기, 유형) 가져오기 등의 기능을 수행하도록 수정.
   - `filePath`, `isDir` 등의 메서드가 로컬/원격 경로를 모두 처리할 수 있도록 인터페이스 변경 또는 조건부 로직 추가.
   - 원격 경로 표시 방식 정의 (예: `ssh://user@host/path/to/file`).
   - 체크 상태 관리(`checked_files_dict`)가 원격 경로에서도 동작하도록 보장.

2. **파일 트리 컨트롤러 수정 (`FileTreeController`):**

   - `select_project_folder` 로직 수정: SSH 연결 시 로컬 폴더 선택 비활성화 또는 원격 루트 디렉토리 설정 기능 추가.
   - `generate_directory_tree_structure` 로직 수정: SFTP를 사용하여 원격 디렉토리 구조 생성.
   - `rename_item`, `delete_item` 로직 수정: SFTP 명령어를 사용하여 원격 파일/디렉토리 이름 변경 및 삭제 수행.
   - `refresh_tree` 로직 수정: 원격 디렉토리 목록을 다시 읽어오도록 수정.
   - `.gitignore` 로딩 로직 수정: 원격 `.gitignore` 파일을 읽어오거나, 로컬 설정을 사용하도록 정책 결정. (초기에는 로컬 설정 우선 적용 고려)

3. **프롬프트 생성 로직 수정 (`PromptController`, `PromptService`):**

   - `generate_prompt` (Code Enhancer 모드) 로직 수정:
     - 체크된 파일 목록이 원격 경로일 경우, SFTP를 통해 파일 내용을 읽어오도록 수정.
     - 파일 경로를 프롬프트에 포함할 때 원격 경로 형식 사용.
   - `generate_code_enhancer_prompt` 서비스 함수 수정: 원격 경로 형식 처리 가능하도록 개선.

4. **XML 파서 실행 로직 수정 (`XmlController`, `XmlService`):**

   - `run_xml_parser` 로직 수정:
     - XML 내 `<file_path>`가 원격 경로일 경우, SFTP를 통해 파일 생성/수정/삭제 작업을 수행하도록 `XmlService.apply_changes_from_xml` 수정.
     - 작업 대상 디렉토리를 원격 경로로 설정.

5. **상태 저장/로드 로직 검토 (`StateService`, `MainWindow`):**

   - `get_current_state`, `set_current_state` 메서드 검토:
     - `project_folder`가 원격 경로 식별자(예: SSH 연결 별칭 또는 `ssh://` URI)를 저장하도록 수정.
     - 체크된 파일 목록(`checked_files`)에 원격 경로가 포함될 수 있도록 처리.
   - 상태 로드 시, 저장된 원격 프로젝트 식별자를 바탕으로 SSH 자동 연결 시도 기능 고려 (선택 사항).

6. **오류 처리 및 로깅 강화:**
   - SFTP 작업(파일 목록 조회, 읽기, 쓰기, 삭제 등) 중 발생할 수 있는 다양한 오류(권한 없음, 파일 없음, 연결 끊김 등)에 대한 예외 처리 강화.
   - `logging` 모듈을 사용하여 SSH 연결, SFTP 작업, 오류 발생 상황에 대한 상세 로그 기록.

### 테스트 내용

1. **파일 시스템 모델 테스트 (`pytest`):**

   - Mock SFTP 클라이언트 또는 실제 테스트 서버를 사용하여 원격 디렉토리 목록 조회 및 파일 정보 가져오기 기능 테스트.
   - 로컬/원격 경로 처리가 올바르게 분기되는지 확인.
   - 원격 경로에 대한 체크 상태 관리가 정상 동작하는지 확인.

2. **파일 트리 컨트롤러 기능 테스트 (수동/자동):**

   - SSH 연결 상태에서 파일 트리 뷰가 원격 디렉토리 구조를 올바르게 표시하는지 확인.
   - 원격 파일/디렉토리 이름 변경, 삭제 기능 테스트.
   - 원격 디렉토리 트리 구조 생성 기능 테스트.
   - 파일 트리 새로고침 기능 테스트.
   - (선택적) `pytest-qt`를 이용한 UI 자동화 테스트.

3. **프롬프트 생성 테스트 (`pytest`):**

   - 원격 파일을 선택했을 때 해당 파일 내용이 SFTP를 통해 올바르게 읽혀 프롬프트에 포함되는지 테스트.
   - 프롬프트 내 파일 경로가 원격 형식으로 표시되는지 확인.

4. **XML 파서 실행 테스트 (`pytest`):**

   - XML에 원격 파일 경로가 포함된 경우, SFTP를 통해 파일 생성/수정/삭제 작업이 올바르게 수행되는지 테스트.
   - 원격 파일 작업 중 발생하는 오류 처리 검증.

5. **상태 저장/로드 테스트:**

   - SSH 연결 상태 및 원격 프로젝트 경로, 체크된 원격 파일 목록이 상태 파일에 올바르게 저장되는지 확인.
   - 저장된 상태 파일을 로드했을 때 SSH 연결 정보 및 원격 파일 상태가 복원되는지 확인 (자동 연결 기능 포함 시 해당 기능 테스트).

6. **종합 시나리오 테스트 (수동):**
   - SSH 연결 -> 원격 파일 탐색 및 선택 -> 프롬프트 생성 -> (필요시) Gemini 호출 -> 결과 XML 파싱 및 원격 파일 적용 -> 연결 해제 등 전체 워크플로우 테스트.
   - 다양한 오류 상황(연결 실패, 권한 오류, 파일 없음 등) 시뮬레이션 및 애플리케이션 안정성 확인.

---

**공통 요구사항:**

- 모든 Python 코드는 `black`, `isort`로 포맷팅합니다.
- 타입 힌트를 적극적으로 사용합니다.
- 오류 발생 시 사용자에게 명확한 메시지를 제공하고, 로그에는 상세 정보를 기록합니다.
- 보안(SSH 키/비밀번호 관리)을 고려하여 구현합니다.
- 기존 코드와의 호환성 및 통합성을 유지합니다.
- 각 단계 완료 시 해당 단계의 테스트 케이스를 모두 통과해야 합니다.
