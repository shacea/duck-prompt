# 파일별 기능 상세

이 문서는 DuckPrompt 프로젝트 내 각 주요 파일 및 모듈의 역할과 기능을 설명합니다.

---

## 1. 최상위 파일 및 설정

### 1.1. `main.py`

- **기능**: 프로젝트의 최상위 진입점. `src` 디렉토리를 `sys.path`에 추가하고 `src/app.py`의 `main` 함수를 호출.
- **역할**: Python 인터프리터가 프로젝트 모듈을 찾을 수 있도록 경로 설정 및 애플리케이션 실행 시작.

### 1.2. `src/app.py`

- **기능**: PyQt5 `QApplication`을 초기화하고, `MainWindow` 인스턴스를 생성 및 실행.
- **특이사항**:
  - `.env` 파일 로드 (환경 변수).
  - DPI 스케일링 설정 (Windows 환경).
  - `utils.helpers.init_utils()` 호출하여 유틸리티 초기화 (예: tiktoken 로딩).
  - 애플리케이션 아이콘 설정.

### 1.3. `src/config.yml`

- **기능**: 애플리케이션의 설정을 정의하는 YAML 파일.
- **주요 설정**:
  - `allowed_extensions`: 처리할 파일 확장자 목록.
  - `excluded_dirs`: 무시할 파일/디렉토리 패턴 목록.
  - `default_ignore_list`: 기본적으로 항상 무시할 패턴 목록.

---

## 2. Core 패키지 (`src/core/`)

핵심 비즈니스 로직과 데이터 모델을 포함합니다.

### 2.1. Pydantic 모델 (`src/core/pydantic_models/`)

- **`app_state.py`**: `AppState` 모델 정의. 애플리케이션의 현재 상태(모드, 프로젝트 폴더, 프롬프트 내용, 체크된 파일 등)를 구조화.
- **`config_settings.py`**: `ConfigSettings` 모델 정의. `config.yml` 파일의 내용을 구조화하고 유효성 검사 수행.

### 2.2. 서비스 (`src/core/services/`)

- **`config_service.py`**: `ConfigService` 클래스. `config.yml` 파일을 로드, 저장, 업데이트하며 `ConfigSettings` 모델 사용.
- **`filesystem_service.py`**: `FilesystemService` 클래스. 파일 시스템 관련 작업 처리 (gitignore 로딩, 파일/디렉토리 무시 여부 판단, 디렉토리 트리 생성). `ConfigService` 주입받아 설정 사용.
- **`prompt_service.py`**: `PromptService` 클래스. 다양한 종류의 프롬프트(코드 강화, 메타) 생성 로직 담당.
- **`state_service.py`**: `StateService` 클래스. `AppState` 모델을 사용하여 애플리케이션 상태를 JSON 파일로 저장, 로드, 가져오기, 내보내기, 백업, 복원하는 기능 제공.
- **`template_service.py`**: `TemplateService` 클래스. 프롬프트 템플릿(`.md` 파일)을 로드, 저장, 삭제하는 기능 제공.
- **`xml_service.py`**: `XmlService` 클래스. XML 문자열을 파싱하여 `<code_changes>` 태그 내의 파일 생성/수정/삭제 작업을 수행.

---

## 3. UI 패키지 (`src/ui/`)

사용자 인터페이스와 관련된 코드를 포함합니다.

### 3.1. 컨트롤러 (`src/ui/controllers/`)

- **`file_tree_controller.py`**: 파일 트리 뷰 관련 로직 담당 (폴더 선택, gitignore 로드/저장, 트리 새로고침, 파일/폴더 이름 변경, 삭제, 체크 상태 변경 처리). `FilesystemService`, `ConfigService` 사용.
- **`main_controller.py`**: 애플리케이션 전반의 흐름 제어 (프로그램 리셋, 상태 표시줄 업데이트 등). 다른 컨트롤러 간의 조정 역할 (필요시).
- **`prompt_controller.py`**: 프롬프트 생성 및 클립보드 복사 관련 로직 담당. `PromptService` 사용.
- **`resource_controller.py`**: 리소스 관리 뷰(템플릿/상태 목록) 관련 로직 담당 (목록 로드, 선택 항목 로드/저장/삭제/업데이트, 상태 백업/복원). `TemplateService`, `StateService` 사용.
- **`system_prompt_controller.py`**: (현재는 함수 형태) 기본 시스템 프롬프트 로드 및 선택 관련 로직 담당 (`.env` 파일 연동).
- **`xml_controller.py`**: XML 파서 실행 로직 담당. `XmlService` 사용.

### 3.2. 모델 (`src/ui/models/`)

- **`file_system_models.py`**: 파일 트리 뷰를 위한 PyQt 모델 정의.
  - `FilteredFileSystemModel`: `QFileSystemModel` 확장, 디렉토리 내용을 재귀적으로 미리 로드.
  - `CheckableProxyModel`: `QSortFilterProxyModel` 확장, 체크박스 기능 추가, gitignore 패턴 기반 필터링, 체크 상태 관리.

### 3.3. 위젯 (`src/ui/widgets/`)

- **`custom_tab_bar.py`**: `QTabBar` 확장, 탭 추가("+"), 중간 클릭으로 탭 닫기, 더블 클릭으로 탭 이름 변경 기능 구현. `tab_manager` 사용.
- **`custom_text_edit.py`**: `QTextEdit` 확장, 서식 없는 텍스트 붙여넣기 기능 등 커스터마이징.
- **`tab_manager.py`**: 보호된 탭 이름 목록 관리 및 탭 삭제/이름 변경 가능 여부 확인 함수(`is_tab_deletable`) 제공.

### 3.4. `main_window.py`

- **기능**: 메인 윈도우 UI 구성 요소(메뉴, 버튼, 탭, 트리 뷰 등) 정의 및 배치.
- **역할**:
  - 서비스 및 컨트롤러 인스턴스 생성 및 주입.
  - 위젯 시그널과 컨트롤러 슬롯 연결.
  - 애플리케이션 모드(Code Enhancer/Meta Prompt)에 따른 UI 동적 구성.
  - `AppState` 기반으로 UI 상태 가져오기/설정하기 메서드 제공.

---

## 4. 유틸리티 패키지 (`src/utils/`)

### 4.1. `helpers.py`

- **기능**: 프로젝트 전반에서 사용되는 보조 함수 제공.
- **주요 함수**:
  - `get_project_root()`: 프로젝트 루트 디렉토리 경로 반환.
  - `get_resource_path()`: 리소스 파일 절대 경로 반환.
  - `init_utils()`, `get_encoding()`: `tiktoken` 인코더 초기화 및 접근.
  - `calculate_char_count()`, `calculate_token_count()`: 텍스트 길이 및 토큰 수 계산.

---

## 5. 기타 파일

- **`app_*.spec`**: PyInstaller 빌드 설정 파일 (AMD64, ARM64).
- **`build.bat`**: Windows 환경 빌드 스크립트.
- **`pyproject.toml`**: 프로젝트 메타데이터 및 빌드/도구 설정 (PEP 621).
- **`requirements.txt`, `requirements-dev.txt`**: 의존성 목록 (uv 호환).
- **`uv.lock`**: `uv` 패키지 관리자의 잠금 파일.
- **`README.md`**: 프로젝트 소개, 설치/실행 방법, 사용법 등 문서.
- **`docs/`**: 추가 문서 폴더 (PRD 등).
- **`resources/`**: 아이콘, 기본 프롬프트 템플릿 등 정적 리소스 폴더.
  - `status/`: 상태 저장 파일(`.json`) 기본 저장 위치.

---

- 세부 사용법 및 예시는 README.md, 각 소스코드 내 주석 참조.
