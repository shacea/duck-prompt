# 파일별 기능 상세

이 문서는 DuckPrompt 프로젝트 내 각 주요 파일 및 모듈의 역할과 기능을 설명합니다.

---

## 1. 최상위 파일 및 설정

### 1.1. `main.py`

- **기능**: 프로젝트의 최상위 진입점. `src` 디렉토리를 `sys.path`에 추가하고 `src/app.py`의 `main` 함수를 호출.
- **역할**: Python 인터프리터가 프로젝트 모듈을 찾을 수 있도록 경로 설정 및 애플리케이션 실행 시작.

### 1.2. `src/app.py`

- **기능**: PyQt5 `QApplication`을 초기화하고, `MainWindow` 인스턴스를 생성 및 실행.
- **특이사항**:
  - DPI 스케일링 설정 (Windows 환경).
  - 애플리케이션 아이콘 설정.
  - `MainWindow`가 내부적으로 서비스들을 초기화하고 관리함.

### 1.3. `src/config.yml`

- **기능**: 애플리케이션의 설정을 정의하는 YAML 파일. 환경 설정 다이얼로그를 통해 관리됨.
- **주요 설정**:
  - `default_system_prompt`: 기본 시스템 프롬프트 파일 경로.
  - `allowed_extensions`: 처리할 파일 확장자 목록.
  - `excluded_dirs`: 무시할 파일/디렉토리 패턴 목록 (gitignore 형식).
  - `default_ignore_list`: 기본적으로 항상 무시할 패턴 목록.
  - `gemini_default_model`, `claude_default_model`: 각 LLM의 기본 모델명.
  - `gemini_api_key`, `anthropic_api_key`: 토큰 계산 및 향후 API 연동을 위한 API 키.

---

## 2. Core 패키지 (`src/core/`)

핵심 비즈니스 로직과 데이터 모델을 포함합니다.

### 2.1. Pydantic 모델 (`src/core/pydantic_models/`)

- **`app_state.py`**: `AppState` 모델 정의. 애플리케이션의 현재 상태(모드, 프로젝트 폴더, 프롬프트 내용, 체크된 파일, 선택된 LLM/모델명 등)를 구조화.
- **`config_settings.py`**: `ConfigSettings` 모델 정의. `config.yml` 파일의 내용을 구조화하고 유효성 검사 수행. API 키, 모델명 필드 추가됨.

### 2.2. 서비스 (`src/core/services/`)

- **`config_service.py`**: `ConfigService` 클래스. `config.yml` 파일을 로드, 저장, 업데이트하며 `ConfigSettings` 모델 사용. 기본 모델명/API 키 접근 메서드 제공.
- **`filesystem_service.py`**: `FilesystemService` 클래스. 파일 시스템 관련 작업 처리 (gitignore 로딩, 파일/디렉토리 무시 여부 판단, 디렉토리 트리 생성). `ConfigService` 주입받아 설정 사용.
- **`prompt_service.py`**: `PromptService` 클래스. 다양한 종류의 프롬프트(코드 강화, 메타) 생성 로직 담당.
- **`state_service.py`**: `StateService` 클래스. `AppState` 모델을 사용하여 애플리케이션 상태를 JSON 파일로 저장, 로드, 가져오기, 내보내기, 백업, 복원하는 기능 제공.
- **`template_service.py`**: `TemplateService` 클래스. 프롬프트 템플릿(`.md` 파일)을 로드, 저장, 삭제하는 기능 제공.
- **`token_service.py`**: `TokenCalculationService` 클래스. GPT(`tiktoken`), Gemini(API), Claude(API) 모델별 토큰 계산 로직 담당. `ConfigService`를 통해 API 키 및 모델명 사용.
- **`xml_service.py`**: `XmlService` 클래스. XML 문자열을 파싱하여 `<code_changes>` 태그 내의 파일 생성/수정/삭제 작업을 수행.

---

## 3. UI 패키지 (`src/ui/`)

사용자 인터페이스와 관련된 코드를 포함합니다.

### 3.1. 컨트롤러 (`src/ui/controllers/`)

- **`file_tree_controller.py`**: 파일 트리 뷰 관련 로직 담당 (폴더 선택, gitignore 로드/필터 업데이트, 트리 새로고침, 파일/폴더 이름 변경, 삭제, 체크 상태 변경 처리). `FilesystemService`, `ConfigService` 사용. SettingsDialog와 연동하여 gitignore 관리.
- **`main_controller.py`**: 애플리케이션 전반의 흐름 제어 (프로그램 리셋, 상태 표시줄 업데이트 - 문자/토큰 수). LLM 선택 및 모델명 변경 처리, `TokenCalculationService` 호출.
- **`prompt_controller.py`**: 프롬프트 생성 및 클립보드 복사 관련 로직 담당. `PromptService` 사용. 프롬프트 생성 후 토큰 계산 트리거.
- **`resource_controller.py`**: 리소스 관리 뷰(템플릿/상태 목록) 관련 로직 담당 (목록 로드, 선택 항목 로드/저장/삭제/업데이트, 상태 백업/복원). `TemplateService`, `StateService` 사용. 버튼 레이블 동적 변경.
- **`system_prompt_controller.py`**: (함수 형태) 기본 시스템 프롬프트 로드(`apply_default_system_prompt`) 및 선택(`select_default_system_prompt`) 관련 로직 담당. `ConfigService` 연동.
- **`xml_controller.py`**: XML 파서 실행 로직 담당. `XmlService` 사용. 실행 후 파일 트리 새로고침 트리거.

### 3.2. 모델 (`src/ui/models/`)

- **`file_system_models.py`**: 파일 트리 뷰를 위한 PyQt 모델 정의.
  - `FilteredFileSystemModel`: `QFileSystemModel` 확장, 디렉토리 내용을 재귀적으로 미리 로드.
  - `CheckableProxyModel`: `QSortFilterProxyModel` 확장, 체크박스 기능 추가, gitignore 패턴 기반 필터링, 체크 상태 관리 (재귀적/다중 선택 처리), 파일 크기 표시.

### 3.3. 위젯 (`src/ui/widgets/`)

- **`custom_tab_bar.py`**: `QTabBar` 확장, 탭 추가("+"), 중간 클릭으로 탭 닫기, 더블 클릭으로 탭 이름 변경 기능 구현. `tab_manager` 사용.
- **`custom_text_edit.py`**: `QTextEdit` 확장, 서식 없는 텍스트 붙여넣기 기능 등 커스터마이징.
- **`tab_manager.py`**: 보호된 탭 이름 목록 관리 및 탭 삭제/이름 변경 가능 여부 확인 함수(`is_tab_deletable`) 제공.

### 3.4. `main_window.py`

- **기능**: 메인 윈도우 클래스. UI 구성 요소 생성 및 배치 로직은 `main_window_setup_ui.py`로, 시그널 연결 로직은 `main_window_setup_signals.py`로 분리됨.
- **역할**:
  - 서비스 및 컨트롤러 인스턴스 생성 및 주입.
  - 애플리케이션 모드(Code Enhancer/Meta Prompt)에 따른 UI 동적 구성.
  - `AppState` 기반으로 UI 상태 가져오기/설정하기 메서드 제공.
  - 환경 설정 다이얼로그(`SettingsDialog`) 열기 및 설정 적용 로직 포함.

### 3.5. `main_window_setup_ui.py`

- **기능**: `MainWindow`의 UI 위젯(메뉴, 버튼, 탭, 트리 뷰, 상태 표시줄 등) 생성 및 레이아웃 배치 담당.

### 3.6. `main_window_setup_signals.py`

- **기능**: `MainWindow`의 UI 위젯 시그널과 해당 컨트롤러 슬롯(또는 `MainWindow` 메서드) 연결 담당.

### 3.7. `settings_dialog.py`

- **기능**: 환경 설정(`config.yml`) 및 현재 프로젝트의 `.gitignore` 파일을 관리하는 다이얼로그 창 UI 및 로직 구현. `ConfigService`와 상호작용.

---

## 4. 유틸리티 패키지 (`src/utils/`)

### 4.1. `helpers.py`

- **기능**: 프로젝트 전반에서 사용되는 보조 함수 제공.
- **주요 함수**:
  - `get_project_root()`: 프로젝트 루트 디렉토리 경로 반환.
  - `get_resource_path()`: 리소스 파일 절대 경로 반환.
  - `calculate_char_count()`: 텍스트 길이 계산.
  - (제거됨) `init_utils()`, `get_encoding()`, `calculate_token_count()`: 토큰 관련 로직은 `TokenCalculationService`로 이동.

---

## 5. 기타 파일

- **`app_*.spec`**: PyInstaller 빌드 설정 파일 (AMD64, ARM64). 의존성 및 포함 리소스 업데이트됨.
- **`build.bat`**: Windows 환경 빌드 스크립트. `uv run` 사용하도록 업데이트됨.
- **`pyproject.toml`**: 프로젝트 메타데이터 및 빌드/도구 설정 (PEP 621). 의존성 업데이트됨 (`google-generativeai`, `anthropic` 추가).
- **`requirements.txt`, `requirements-dev.txt`**: 의존성 목록 (uv 호환). 업데이트됨.
- **`uv.lock`**: `uv` 패키지 관리자의 잠금 파일.
- **`README.md`**: 프로젝트 소개, 설치/실행 방법, 사용법 등 문서. 업데이트됨.
- **`docs/`**: 추가 문서 폴더 (PRD 등).
- **`resources/`**: 아이콘, 기본 프롬프트 템플릿 등 정적 리소스 폴더.
  - `status/`: 상태 저장 파일(`.json`) 기본 저장 위치.

---

- 세부 사용법 및 예시는 README.md, 각 소스코드 내 주석 참조.
