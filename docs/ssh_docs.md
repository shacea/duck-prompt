# SSH 접속 기능 설명서

이 문서는 기존 DuckPrompt 애플리케이션에서 SSH 접속 관련 기능만 분리하여 독립적인 프로그램으로 구성했을 경우를 가정하고, 해당 프로그램의 구조, 기능, 프로세스, UI/UX에 대해 설명합니다.

## 1. 개요

SSH 접속 프로그램은 사용자가 원격 서버에 안전하게 접속하고, GUI 환경에서 원격 파일 시스템을 탐색하며 파일을 관리할 수 있도록 돕는 데스크톱 애플리케이션입니다. 사용자는 여러 SSH 연결 설정을 저장하고 관리할 수 있으며, 필요에 따라 원하는 서버에 쉽게 접속할 수 있습니다.

## 2. 프로그램 구조

프로그램은 PyQt6를 사용한 GUI와 백엔드 로직으로 구성되며, 주요 모듈 및 역할은 다음과 같습니다.

- **UI (User Interface)**:
  - `MainWindow`: 메인 애플리케이션 창. SSH 연결 선택 드롭다운, 연결/해제 버튼, 연결 상태 표시 레이블, 원격 파일 시스템을 보여주는 파일 트리 뷰 등을 포함합니다.
  - `SettingsDialog`: 환경 설정 창. SSH 연결 설정을 관리(추가/수정/삭제/테스트)하는 탭을 포함합니다.
  - `SshConfigDialog`: SSH 연결 설정을 추가하거나 수정하기 위한 별도의 다이얼로그입니다.
- **Controllers**:
  - `SshController`: SSH 연결 및 해제 로직, 연결 상태 관리, Keep-alive 처리 등을 담당합니다. 백그라운드 스레드(`SshWorker`)를 사용하여 UI 블로킹 없이 연결을 시도합니다.
  - `SshConfigService`: SSH 연결 설정 정보에 대한 CRUD(Create, Read, Update, Delete) 로직을 처리합니다. `DbService`를 통해 데이터베이스와 상호작용합니다.
  - `FileTreeController`: 파일 트리 뷰의 동작(폴더 확장, 아이템 선택 등)과 원격 파일 시스템 관련 작업(이름 변경, 삭제 등) 요청을 처리합니다. `FilesystemService`를 사용합니다.
  - `MainController`: (필요시) 애플리케이션 전반의 흐름 제어 및 컨트롤러 간 조정 역할을 수행합니다.
- **Core Services**:
  - `FilesystemService`: 로컬 및 원격(SFTP) 파일 시스템 작업을 추상화하여 제공합니다. `SshController`로부터 SFTP 클라이언트를 받아 원격 파일 목록 조회, 읽기, 쓰기, 삭제 등의 작업을 수행합니다.
  - `DbService`: PostgreSQL 데이터베이스와의 연결 및 쿼리 실행을 담당합니다. SSH 설정 정보 등을 저장하고 조회합니다.
  - `paramiko`: SSH 연결 및 SFTP 통신을 위한 핵심 라이브러리입니다.
- **Data Models**:
  - `SshConnectionConfig` (Pydantic): SSH 연결 설정 정보(별칭, 호스트, 포트, 사용자명, 인증 방식, 비밀번호/키 경로 등)의 데이터 구조를 정의하고 유효성을 검증합니다.
- **Utils**:
  - `postgres_db_initializer.py`: 데이터베이스 스키마(테이블 생성 등)를 초기화하는 스크립트입니다. `ssh_connections` 테이블 정의를 포함합니다.

## 3. 핵심 기능

### 3.1. SSH 설정 관리

- **설정 추가/수정/삭제**: 사용자는 환경 설정 다이얼로그를 통해 SSH 연결 설정을 추가, 수정, 삭제할 수 있습니다.
  - **입력 정보**: 별칭, 호스트 주소(IP 또는 도메인), 포트 번호, 사용자명, 인증 방식(비밀번호 또는 키 파일), 비밀번호 또는 개인 키 파일 경로.
  - **저장**: 입력된 정보는 `SshConnectionConfig` 모델로 유효성 검사를 거쳐 데이터베이스(`ssh_connections` 테이블)에 저장됩니다. 비밀번호는 암호화되어 저장될 수 있습니다 (구현에 따라 다름).
- **설정 목록 조회**: 저장된 SSH 연결 설정 목록을 환경 설정 다이얼로그의 테이블 뷰에 표시합니다. 메인 화면의 연결 선택 콤보박스에도 로드됩니다.
- **연결 테스트**: 환경 설정 다이얼로그에서 선택한 설정 정보로 실제 SSH 서버에 연결을 시도하고 성공/실패 여부를 사용자에게 피드백합니다. UI 블로킹을 방지하기 위해 백그라운드 스레드(`SshConnectionTester`)에서 실행됩니다.

### 3.2. SSH 연결 및 해제

- **연결 시도**: 메인 화면 상단의 콤보박스에서 저장된 연결 설정을 선택하고 '연결' 버튼을 클릭하여 SSH 연결을 시도합니다.
  - 비밀번호 인증 시, 필요에 따라 연결 시점에 비밀번호를 다시 입력받을 수 있습니다.
  - 연결 과정은 백그라운드 스레드(`SshWorker`)에서 처리되어 UI 응답성을 유지합니다.
- **연결 상태 표시**: 메인 화면 상단 레이블에 현재 연결 상태("미연결", "연결 중...", "연결됨: [별칭]")를 표시합니다.
- **연결 성공**:
  - `paramiko.SSHClient` 및 `paramiko.SFTPClient` 인스턴스가 생성 및 유지됩니다.
  - 연결 버튼 텍스트가 "연결 해제"로 변경됩니다.
  - 파일 트리 뷰가 원격 파일 시스템을 표시하도록 전환됩니다.
  - 로컬 프로젝트 폴더 선택 기능이 비활성화됩니다.
  - 연결 유지를 위한 Keep-alive 메시지가 주기적으로 전송될 수 있습니다.
- **연결 실패**: 사용자에게 오류 메시지(인증 실패, 타임아웃 등)를 표시하고 연결 상태를 "미연결"로 복원합니다.
- **연결 해제**: "연결 해제" 버튼을 클릭하거나 애플리케이션 종료 시 SSH 및 SFTP 연결을 안전하게 종료하고 관련 리소스를 정리합니다. 파일 트리 뷰는 로컬 모드로 복원되고 로컬 폴더 선택 기능이 활성화됩니다.

### 3.3. 원격 파일 시스템 탐색 및 조작

- **원격 디렉토리 탐색**: SSH 연결 성공 후, 파일 트리 뷰는 `FilesystemService`와 SFTP 클라이언트를 사용하여 원격 서버의 디렉토리 구조를 표시합니다. 폴더를 확장하면 해당 폴더의 내용을 동적으로 로드합니다.
- **파일/폴더 정보 표시**: 파일 트리 뷰에 파일/폴더 이름, 아이콘, 크기 등을 표시합니다.
- **파일 작업**: 파일 트리 뷰의 컨텍스트 메뉴 또는 단축키를 통해 다음 작업을 수행할 수 있습니다.
  - **이름 변경**: 원격 파일 또는 폴더의 이름을 변경합니다. (`SFTPClient.rename`)
  - **삭제**: 원격 파일 또는 폴더를 삭제합니다. (`SFTPClient.remove`, `SFTPClient.rmdir`)
  - **(구현 시)** 파일 생성, 폴더 생성, 파일 다운로드/업로드 등.
- **파일 내용 읽기/쓰기**: (구현 시) 원격 파일을 열어 내용을 읽거나 수정하여 저장하는 기능을 제공할 수 있습니다. (`SFTPClient.open`)

## 4. 주요 프로세스

1. **최초 실행**: 데이터베이스 스키마 확인 및 초기화. 저장된 SSH 설정 로드하여 메인 화면 콤보박스 채우기.
2. **설정 추가/수정**: 사용자가 환경 설정 다이얼로그를 열어 SSH 설정 추가/수정. 입력값 유효성 검사 후 DB 저장. 연결 테스트 수행.
3. **연결 시도**: 사용자가 메인 화면에서 연결 설정 선택 후 '연결' 버튼 클릭.
4. **백그라운드 연결**: `SshController`가 `SshWorker` 스레드 시작. Worker는 `paramiko`를 사용하여 SSH 연결 시도 (인증 포함).
5. **결과 처리**: Worker 스레드가 연결 성공/실패 결과를 `SshController`에 시그널로 전달.
6. **UI 업데이트 (성공 시)**: `SshController`가 연결 상태 업데이트, SFTP 클라이언트 열기, 파일 트리 원격 모드 전환 요청.
7. **원격 파일 탐색**: 사용자가 파일 트리에서 폴더 확장 시, `FileTreeController`가 `FilesystemService`를 통해 SFTP로 해당 디렉토리 목록 조회 후 트리 뷰 업데이트.
8. **파일 조작**: 사용자가 파일 트리에서 이름 변경/삭제 등 작업 요청 시, `FileTreeController`가 `FilesystemService`를 통해 SFTP 명령 수행 후 트리 뷰 새로고침.
9. **연결 해제**: 사용자가 '연결 해제' 버튼 클릭 시, `SshController`가 SFTP/SSH 연결 종료, 파일 트리 로컬 모드 복원.

## 5. UI/UX (사용자 인터페이스 / 사용자 경험)

- **메인 화면 (`MainWindow`)**:
  - **상단**:
    - SSH 연결 선택 `QComboBox`: 저장된 연결 설정 목록 표시.
    - 연결/해제 `QPushButton`: 현재 상태에 따라 텍스트 변경 ("연결" 또는 "연결 해제").
    - 연결 상태 `QLabel`: "미연결", "연결 중...", "연결됨: [별칭]" 등 상태 표시.
  - **왼쪽**:
    - 파일 트리 `QTreeView`: 로컬 또는 원격 파일 시스템 표시. 폴더 확장/축소 가능. 컨텍스트 메뉴 제공 (이름 변경, 삭제 등).
  - **오른쪽**: (기존 DuckPrompt UI 요소는 제외)
- **환경 설정 (`SettingsDialog`)**:
  - **SSH 설정 탭**:
    - `QTableWidget`: 저장된 SSH 연결 목록 표시 (ID, 별칭, 호스트, 포트, 사용자명).
    - `QPushButton` (추가, 수정, 삭제): 테이블 아래에 위치하여 목록 관리 기능 제공.
    - `QPushButton` (연결 테스트): 선택된 설정으로 연결 테스트 수행.
  - **SSH 설정 추가/수정 다이얼로그 (`SshConfigDialog`)**:
    - `QLineEdit` (별칭, 호스트, 포트, 사용자명, 비밀번호, 키 경로): 설정 정보 입력 필드.
    - `QComboBox` (인증 방식): 'password' 또는 'key' 선택.
    - `QPushButton` (찾아보기): 키 파일 선택 다이얼로그 열기.
    - 인증 방식 선택에 따라 비밀번호 또는 키 경로 필드만 활성화/표시.
- **사용성**:
  - 연결/테스트 등 시간이 걸리는 작업은 백그라운드 스레드에서 처리하여 UI 멈춤 현상 방지.
  - 연결 상태 및 오류 발생 시 명확한 피드백 제공 (상태 레이블, 메시지 박스).
  - 자주 사용하는 연결 설정을 저장하여 재입력 없이 빠르게 접속 가능.
