# DuckPrompt

이 애플리케이션은 PyQt5로 구현된 통합 Prompt Builder입니다. 아래 안내를 따라 편리하게 사용할 수 있어요.

**현재 리팩토링 진행 중입니다. (2단계 완료)**

---

## 목차

1. [프로그램 개요](#프로그램-개요)
2. [설치 및 실행](#설치-및-실행)
3. [주요 기능과 사용 방법](#주요-기능과-사용-방법)
   1. [프로젝트 폴더 선택하기](#프로젝트-폴더-선택하기)
   2. [프롬프트 빌더 모드](#프롬프트-빌더-모드)
   3. [메타 프롬프트 빌더 모드](#메타-프롬프트-빌더-모드)
   4. [디렉토리 트리 생성](#디렉토리-트리-생성)
   5. [XML 파서 사용](#xml-파서-사용)
   6. [템플릿/상태 관리](#템플릿상태-관리)
   7. [토큰 수 계산](#토큰-수-계산)
   8. [환경 설정](#환경-설정)
4. [개발 환경 설정 (리팩토링)](#개발-환경-설정-리팩토링)
5. [기타 자주 묻는 질문 (FAQ)](#기타-자주-묻는-질문-faq)
6. [문의](#문의)

---

## 프로그램 개요

DuckPrompt는 여러 개의 파일을 선택한 뒤 그 내용을 합쳐서 LLM(Language Model)에 넘기기 위한 “프롬프트”를 손쉽게 생성하도록 도와주는 도구입니다.

- **코드 강화 빌더 모드**: 체크한 파일 내용 + 시스템 프롬프트 + 사용자 프롬프트를 합쳐 “최종 프롬프트”를 만들어 줍니다. LLM의 XML 응답을 파싱하여 파일에 적용하는 기능도 포함합니다.
- **메타 프롬프트 빌더 모드**: 이미 만들어진 하나의 프롬프트를 또 다른 템플릿(“메타 프롬프트”)으로 감싸 새로운 형태의 요청을 만들어 줍니다. 변수 치환 기능도 제공합니다.
- **LLM별 토큰 계산**: GPT, Claude, Gemini 모델에 맞춰 토큰 수를 계산하여 프롬프트 길이를 가늠할 수 있도록 도와줍니다. (API 키 설정 필요)
- **환경 설정**: GUI를 통해 기본 설정(기본 프롬프트, 모델명, API 키, 필터링 규칙 등)을 쉽게 관리할 수 있습니다.

---

## 설치 및 실행

1.  **의존성 설치**

    - Python 3.12 이상 권장.
    - **`uv`** 패키지 관리자 사용 권장 (`pip install uv`).
    - 가상환경 생성: `uv venv`
    - 가상환경 활성화: (OS별 활성화 스크립트 실행 - 예: Windows에서 `.venv\Scripts\activate`)
    - 기본 의존성 설치: `uv pip install -r requirements.txt`
      - **참고**: `requirements.txt`에는 Gemini/Claude 토큰 계산 및 LangGraph 연동에 필요한 `google-generativeai`, `anthropic`, `langgraph`, `langchain`, `langchain-google-genai` 라이브러리가 포함되어 있습니다.

2.  **빌드(선택 사항)**

    - 개발 의존성 설치: `uv pip install -r requirements-dev.txt`
    - `build.bat` 파일을 실행하여 PyInstaller로 빌드할 수 있습니다 (Windows 환경).
    - 빌드 후 `dist/DuckPrompt` 폴더에 `DuckPrompt.exe`가 생성됩니다.
    - 시스템 아키텍처(AMD64/ARM64)에 맞는 spec 파일(`app_amd64.spec`, `app_arm64.spec`)을 자동으로 사용합니다.

3.  **실행**
    - 빌드된 실행 파일 사용:
      - `dist/DuckPrompt/DuckPrompt.exe`를 더블 클릭.
    - 혹은 Python 명령으로 직접 실행 (가상환경 활성화 후):
      ```bash
      uv run python main.py
      ```
      또는
      ```bash
      python main.py
      ```

---

## 주요 기능과 사용 방법

### 프로젝트 폴더 선택하기

1. 프로그램 실행 후 상단의 **📁 프로젝트 폴더 선택** 버튼을 클릭합니다. (코드 강화 빌더 모드에서만 필요)
2. 원하는 로컬 폴더를 지정하면, 왼쪽 창(파일 트리)에 해당 폴더 하위 파일들이 나타납니다.
3. 체크박스를 통해 어떤 파일을 프롬프트에 포함할지 선택하세요.
   - 폴더에 체크하면 해당 폴더의 하위 모든 파일/폴더가 자동으로 선택됩니다. (숨김 처리된 파일 제외)
   - 파일/폴더 이름을 클릭하면 체크 상태가 토글됩니다.
   - 파일 이름 뒤에는 크기가 표시됩니다.
   - 파일 트리 항목에서 마우스 오른쪽 버튼을 클릭하여 이름 변경 또는 삭제할 수 있습니다.

### 프롬프트 빌더 모드

DuckPrompt는 두 가지 모드로 실행됩니다. 상단 메뉴 "모드" 또는 "🔄 모드 전환" 버튼으로 전환할 수 있습니다.

- **코드 강화 빌더 모드**: 일반적인 “시스템 프롬프트 + 사용자 프롬프트 + 선택 파일 내용”을 합쳐줍니다.
- **메타 프롬프트 빌더 모드**: 기존 프롬프트를 다른 템플릿으로 감싸는 데 사용됩니다.

#### 사용 방법 (코드 강화 빌더 모드)

1. **시스템 탭**과 **사용자 탭**에 프롬프트 초안을 작성합니다. (프로그램 시작 시 `src/config.yml`에 지정된 기본 시스템 프롬프트가 로드됩니다. [환경 설정](#환경-설정) 참조)
2. 좌측 트리에서 합치고 싶은 파일들을 체크합니다.
3. 우측 상단의 **✨ 프롬프트 생성** 버튼 (또는 단축키 `Ctrl+Enter`로 **⚡️ 한번에 실행**)을 누르면 우측의 “프롬프트 출력” 탭에 결과가 생깁니다.
4. **📋 클립보드에 복사** 버튼을 눌러 바로 붙여넣기 할 수 있습니다.
5. 복사된 내용을 GPT, Gemini, Claude 등의 LLM에게 붙여넣어 바로 질문할 수 있습니다.
6. 시스템 프롬프트에 XML 가이드 프롬프트를 사용했다면, LLM의 답변은 XML 형식일 가능성이 높습니다.
7. **♊ Gemini로 전송** 버튼을 누르면 생성된 프롬프트를 Gemini API로 직접 전송하고, 응답을 "XML 입력" 탭과 "Summary" 탭에 자동으로 채워줍니다. (API 키 설정 필요)

### 메타 프롬프트 빌더 모드

1.  상단 메뉴 "모드" 또는 "🔄 모드 전환" 버튼을 클릭하여 "메타 프롬프트 빌더" 모드로 전환합니다.
2.  **메타 프롬프트 템플릿** 탭에 프롬프트를 감쌀 상위 템플릿을 작성합니다. (`[[user-prompt]]` 와 같이 변수 사용 가능)
3.  **메타 사용자 입력** 탭에 실제로 사용자에게 요청할 내용을 적습니다.
4.  **🚀 메타 프롬프트 생성** 버튼을 누르면 “메타 프롬프트 출력” 탭에서 결과를 볼 수 있습니다.
5.  필요 시, 추가 탭(`var-이름` 형태)을 생성하여 변수 내용을 입력하고, **🚀 최종 프롬프트 생성** 버튼 (또는 단축키 `Ctrl+Enter`)으로 변수를 치환해 완성된 형태를 얻을 수도 있습니다.
6.  **📋 메타 프롬프트 복사** 버튼을 눌러 현재 활성화된 탭(메타 프롬프트 출력 또는 최종 프롬프트)의 내용을 복사할 수 있습니다.

### 디렉토리 트리 생성

- 코드 강화 빌더 모드에서 사용합니다.
- 우측 상단의 **🌳 트리 생성** 버튼을 누르면, 체크된 파일/폴더를 기준으로 디렉토리 구조를 텍스트 형태로 생성합니다.
- “파일 트리” 탭에서 결과를 볼 수 있습니다. LLM에 “디렉토리 구조”를 보여주어야 할 때 유용합니다.

### XML 파서 사용

- 코드 강화 빌더 모드에서 사용합니다.
- LLM이 생성한 `<code_changes>` 형식의 XML 응답을 복사합니다.
- “XML 입력” 탭에 붙여넣고, **▶️ XML 파서 실행** 버튼을 클릭하면 해당 내용대로 프로젝트 폴더 내 파일 생성/수정/삭제가 일괄 수행됩니다. (별도 확인 없이 바로 실행되므로 주의!)
- 결과 요약은 팝업으로 확인할 수 있습니다.

### 템플릿/상태 관리

- 좌측 하단의 "리소스 관리" 영역에서 관리합니다.
- **리소스 타입 선택**: "프롬프트" 또는 "상태"를 선택합니다.
- **프롬프트**: System/User 프롬프트 템플릿(`.md` 파일)을 관리합니다.
  - 목록에서 더블 클릭하여 해당 탭(시스템/사용자)에 불러올 수 있습니다.
  - 현재 탭 내용을 새 템플릿으로 저장하거나, 기존 템플릿을 업데이트/삭제할 수 있습니다.
- **상태**: 현재 프로그램 상태(선택된 파일, 프롬프트 내용, 선택된 LLM/모델명 등)를 `.json` 파일로 관리합니다.
  - 작업을 중단했다가 나중에 이어서 할 때 유용합니다.
  - 상태 저장/불러오기, 모든 상태 백업/복원 기능을 제공합니다.
  - 상태 파일은 `resources/status/` 폴더에 저장됩니다.

### 토큰 수 계산

- 프로그램 하단 상태 표시줄에서 LLM 모델(Gemini, Claude, GPT)을 선택하고, 사용할 정확한 모델명을 입력할 수 있습니다.
- 텍스트 탭 내용이 변경될 때마다 선택된 모델 기준으로 토큰 수를 자동으로 계산하여 보여줍니다. (API 호출 필요 시 약간의 지연 발생 가능)
- **GPT**: `tiktoken` 라이브러리를 사용하여 로컬에서 계산합니다. (o200k_base 인코딩 기준)
- **Gemini**: Google Generative AI API (`count_tokens`)를 호출하여 계산합니다.
  - **사전 설정**: `src/config.yml` 파일 내 `gemini_api_key` 항목에 유효한 API 키를 입력해야 합니다. (Google AI Studio 또는 Google Cloud Console에서 발급)
- **Claude**: Anthropic API (`messages.count_tokens`)를 호출하여 계산합니다.
  - **사전 설정**: `src/config.yml` 파일 내 `anthropic_api_key` 항목에 유효한 API 키를 입력해야 합니다. (Anthropic Console에서 발급)
- **모델명 저장**: 입력된 모델명은 `config.yml`에 자동으로 저장되지 않습니다. 기본 모델명을 변경하려면 [환경 설정](#환경-설정) 메뉴를 이용하세요.
- **오류 처리**: API 키 누락/오류, 네트워크 문제 등으로 API 호출 실패 시 상태 표시줄에 "토큰 계산 오류" 메시지가 표시됩니다. 터미널/콘솔의 상세 오류 메시지를 확인하세요.

### 환경 설정

- 상단 메뉴 "파일" > "환경 설정..."을 선택하여 설정 다이얼로그를 엽니다.
- **기본 시스템 프롬프트**: 프로그램 시작 시 시스템 탭에 자동으로 로드될 프롬프트 파일 경로를 지정합니다.
- **LLM 기본 모델명**: Gemini, Claude 각각의 기본 모델명을 설정합니다. 상태 표시줄의 모델명 입력란에 기본으로 표시됩니다.
- **API 키**: Gemini, Anthropic API 키를 입력합니다. 토큰 계산 및 Gemini 직접 전송 기능에 사용됩니다. (Password 형태로 표시됨)
- **파일 필터링**:
  - **허용 확장자**: 파일 트리에 표시할 파일 확장자를 지정합니다. (비어있으면 모든 확장자 허용)
  - **제외 폴더/파일**: 파일 트리에 표시하지 않을 파일/폴더 패턴을 `.gitignore` 형식으로 지정합니다.
  - **기본 무시 목록**: 항상 무시할 기본 패턴 목록입니다.
- **.gitignore 편집 (현재 프로젝트)**: 현재 선택된 프로젝트 폴더의 `.gitignore` 파일을 직접 편집하고 저장할 수 있습니다. 저장 시 파일 트리 필터가 즉시 업데이트됩니다.
- **설정 저장**: 변경된 설정을 `src/config.yml` 파일에 저장합니다. 저장 후 일부 설정(기본 프롬프트, 모델명, 필터 등)은 즉시 프로그램에 반영됩니다.

---

## 개발 환경 설정 (리팩토링)

리팩토링 작업 및 개발 기여를 위한 환경 설정입니다.

1.  **Python 버전**: Python 3.12 이상
2.  **패키지 관리**: `uv` 사용 권장 (`pip install uv`)
3.  **가상 환경**:
    - 생성: `uv venv`
    - 활성화: (OS별 스크립트 실행 - 예: `.venv\Scripts\activate` on Windows)
4.  **의존성 설치**:
    - 기본: `uv pip install -r requirements.txt`
    - 개발/테스트: `uv pip install -r requirements-dev.txt`
5.  **코드 실행**: `uv run python main.py` 또는 `python main.py`
6.  **테스트 실행**: `uv run pytest tests/` (테스트 코드 추가 예정)
7.  **타입 체크**: `uv run mypy src/ tests/`
8.  **린팅/포매팅**:
    - 체크: `uv run ruff check .`
    - 포맷: `uv run black .` , `uv run ruff format .`
9.  **프로젝트 구조**:
    - 모든 소스 코드는 `src/` 디렉토리 하위에 위치합니다 (`core`, `ui`, `utils` 패키지 포함).
    - 테스트 코드는 `tests/` 디렉토리 하위에 위치합니다.
    - 설정 파일은 `src/config.yml` 입니다. (환경 설정 다이얼로그를 통해 관리)
    - Pydantic 모델은 `src/core/pydantic_models/` 에 정의됩니다.
    - 핵심 로직 서비스는 `src/core/services/` 에 위치합니다.
    - UI 컨트롤러는 `src/ui/controllers/` 에 위치합니다.
    - UI 위젯/모델/설정 코드는 `src/ui/` 하위에 분리되어 있습니다.

---

## 기타 자주 묻는 질문 (FAQ)

1.  **파일이 많으면 프로그램이 느려지나요?**
    - 파일 트리를 표시하는 데 시간이 걸릴 수 있지만, 프롬프트 생성 시에는 체크된 파일만 처리하므로 필요한 파일만 선택하면 성능에 큰 영향은 없습니다. `.gitignore` 및 설정의 필터링 규칙을 활용하여 불필요한 파일/폴더를 숨길 수 있습니다.
2.  **토큰 계산이 정확한가요?**
    - **GPT**: `tiktoken` 라이브러리를 통해 로컬에서 계산하며, 비교적 정확한 추정치를 제공합니다.
    - **Claude/Gemini**: 각 서비스의 공식 API를 호출하여 계산하므로 가장 정확합니다. 단, API 키 설정이 필요하며 네트워크 연결이 원활해야 합니다. API 호출 실패 시 계산이 불가능합니다.
3.  **기본 시스템 프롬프트 지정은 어떻게 하나요?**
    - 상단 메뉴 "파일" > "환경 설정..."을 열고 "기본 시스템 프롬프트" 섹션에서 "찾아보기..." 버튼을 눌러 원하는 `.md` 또는 `.txt` 파일을 선택한 후, "설정 저장" 버튼을 누릅니다.
4.  **메타 프롬프트 빌더는 언제 사용하나요?**
    - 이미 잘 작성된 프롬프트(예: 특정 역할 수행 지침)를 다른 목적의 프롬프트 템플릿으로 감싸서 재사용하거나 변형해야 할 때 유용합니다.
5.  **Gemini/Claude 토큰 계산 또는 Gemini 직접 전송이 안 돼요.**
    - [토큰 수 계산](#토큰-수-계산) 섹션의 사전 설정 부분을 확인하세요.
    - "환경 설정" 메뉴에서 해당 API 키(`gemini_api_key` 또는 `anthropic_api_key`)가 올바르게 입력되었는지 다시 확인하세요.
    - 인터넷 연결 상태를 확인하세요.
    - 터미널/콘솔에 출력되는 상세 오류 메시지를 확인하여 문제를 진단하세요 (예: `INVALID_API_KEY`, `RateLimitError` 등).

---

## 문의

- 사용 중에 궁금한 점이나 버그가 있다면 이슈로 남겨주세요.
- 감사합니다!