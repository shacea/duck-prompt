
# DuckPrompt

이 애플리케이션은 PyQt5로 구현된 통합 Prompt Builder입니다. 아래 안내를 따라 편리하게 사용할 수 있어요.

**현재 리팩토링 진행 중입니다. (주요 기능 추가 완료, 설정 DB 이전 완료)**

---

## 목차

1. [프로그램 개요](#프로그램-개요)
2. [설치 및 실행](#설치-및-실행)
3. [주요 기능과 사용 방법](#주요-기능과-사용-방법)
   1. [프로젝트 폴더 선택하기](#프로젝트-폴더-선택하기)
   2. [프롬프트 빌더 모드](#프롬프트-빌더-모드)
   3. [메타 프롬프트 빌더 모드](#메타-프롬프트-빌더-모드)
   4. [첨부 파일 관리](#첨부-파일-관리)
   5. [디렉토리 트리 생성](#디렉토리-트리-생성)
   6. [XML 파서 사용](#xml-파서-사용)
   7. [템플릿/상태 관리](#템플릿상태-관리)
   8. [토큰 수 계산](#토큰-수-계산)
   9. [Gemini API 직접 호출](#gemini-api-직접-호출)
   10. [환경 설정](#환경-설정)
4. [개발 환경 설정 (리팩토링)](#개발-환경-설정-리팩토링)
5. [기타 자주 묻는 질문 (FAQ)](#기타-자주-묻는-질문-faq)
6. [문의](#문의)

---

## 프로그램 개요

DuckPrompt는 여러 개의 파일 내용과 첨부 파일(이미지, 일반 파일)을 쉽게 통합하여 LLM(대규모 언어 모델)에게 전달할 프롬프트를 생성하는 GUI 도구입니다. Gemini API와 직접 연동하여 프롬프트를 전송하고 구조화된 응답(XML, 요약)을 받을 수 있습니다.

- **코드 강화 빌더 모드**: 체크한 파일 내용 + 첨부 파일 + 시스템 프롬프트 + 사용자 프롬프트를 합쳐 “최종 프롬프트”를 만들어 줍니다. Gemini API 직접 호출 및 XML 응답 파싱 기능 포함.
- **메타 프롬프트 빌더 모드**: 이미 만들어진 하나의 프롬프트를 또 다른 템플릿(“메타 프롬프트”)으로 감싸 새로운 형태의 요청을 만들어 줍니다. 변수 치환 기능도 제공합니다.
- **LLM별 토큰 계산**: GPT, Claude, Gemini 모델에 맞춰 토큰 수를 계산하여 프롬프트 길이를 가늠할 수 있도록 도와줍니다. (Gemini는 멀티모달 입력 지원, API 키 설정 필요)
- **환경 설정**: **환경 설정 메뉴**를 통해 DB에 저장된 설정을 확인하고, `.gitignore` 파일을 편집/저장할 수 있습니다. (DB 설정 직접 수정은 지원하지 않음)
- **상태 관리**: **"⏪ 마지막 작업 불러오기" 버튼** 또는 상태 메뉴를 통해 이전 작업 상태(프로젝트 폴더, 사용자 프롬프트, 첨부 파일, **체크된 파일/폴더 목록**)를 쉽게 불러올 수 있습니다.

---

## 설치 및 실행

1.  **데이터베이스 설정**:
    - 제공된 `docs/duck_agent_2025-04-25_112248.sql` 파일을 사용하여 PostgreSQL 데이터베이스(duck_agent)를 설정합니다.
    - 데이터베이스 접속 정보는 `src/core/services/db_service.py` 파일 내 `DB_CONFIG` 변수에 하드코딩되어 있습니다. 필요시 해당 파일을 직접 수정하거나, 환경 변수 등으로 관리하도록 변경할 수 있습니다.
    - **주의**: 데이터베이스 연결이 불가능하면 프로그램이 시작되지 않습니다.

2.  **의존성 설치**

    - Python 3.12 이상 권장.
    - **`uv`** 패키지 관리자 사용 권장 (`pip install uv`).
    - 가상환경 생성: `uv venv`
    - 가상환경 활성화: (OS별 활성화 스크립트 실행 - 예: Windows에서 `.venv\Scripts\activate`)
    - 기본 의존성 설치: `uv pip install -r requirements.txt`
      - **참고**: `requirements.txt`에는 Gemini/Claude 토큰 계산, LangGraph 연동, 이미지 처리, **PostgreSQL 연결(`psycopg2-binary`)**에 필요한 라이브러리가 포함되어 있습니다.

3.  **빌드(선택 사항)**

    - 개발 의존성 설치: `uv pip install -r requirements-dev.txt`
    - `build.bat` 파일을 실행하여 PyInstaller로 빌드할 수 있습니다 (Windows 환경).
    - 빌드 후 `dist/DuckPrompt` 폴더에 `DuckPrompt.exe`가 생성됩니다.
    - 시스템 아키텍처(AMD64/ARM64)에 맞는 spec 파일(`app_amd64.spec`, `app_arm64.spec`)을 자동으로 사용합니다.

4.  **실행**
    - 빌드된 실행 파일 사용:
      - `dist/DuckPrompt/DuckPrompt.exe`를 더블 클릭.
    - 혹은 Python 명령으로 직접 실행 (가상환경 활성화 후):
      ```bash
      uv run python main.py
      ```
      또는
      ```bash
      python main.py
      ```

---

## 주요 기능과 사용 방법

### 프로젝트 폴더 선택하기

1. 프로그램 실행 후 상단의 **📁 프로젝트 폴더 선택** 버튼을 클릭합니다. (코드 강화 빌더 모드에서만 필요)
2. 원하는 로컬 폴더를 지정하면, 왼쪽 창(파일 트리)에 해당 폴더 하위 파일들이 나타납니다.
3. 체크박스를 통해 어떤 파일을 프롬프트에 포함할지 선택하세요.
   - 폴더에 체크하면 해당 폴더의 하위 모든 파일/폴더가 자동으로 선택됩니다. (숨김 처리된 파일 제외)
   - 파일/폴더 이름을 클릭하면 체크 상태가 토글됩니다.
   - 파일 이름 뒤에는 크기가 표시됩니다.
   - 파일 트리 항목에서 마우스 오른쪽 버튼을 클릭하여 이름 변경 또는 삭제할 수 있습니다.

### 프롬프트 빌더 모드

DuckPrompt는 두 가지 모드로 실행됩니다. 상단 메뉴 "모드" 또는 "🔄 모드 전환" 버튼으로 전환할 수 있습니다.

- **코드 강화 빌더 모드**: 일반적인 “시스템 프롬프트 + 사용자 프롬프트 + 선택 파일 내용 + 첨부 파일 정보”를 합쳐줍니다. Gemini API 직접 호출 및 XML 응답 파싱 기능 포함.
- **메타 프롬프트 빌더 모드**: 기존 프롬프트를 다른 템플릿으로 감싸는 데 사용됩니다.

#### 사용 방법 (코드 강화 빌더 모드)

1. **시스템 탭**과 **사용자 탭**에 프롬프트 초안을 작성합니다. (프로그램 시작 시 **데이터베이스**에 지정된 기본 시스템 프롬프트가 로드됩니다. [환경 설정](#환경-설정) 참조)
2. 좌측 트리에서 합치고 싶은 파일들을 체크합니다.
3. 필요 시, [첨부 파일 관리](#첨부-파일-관리) 기능을 사용하여 이미지나 추가 파일을 첨부합니다.
4. 우측 상단의 **✨ 프롬프트 생성** 버튼 (또는 단축키 `Ctrl+Enter`로 **⚡️ 한번에 실행**)을 누르면 우측의 “프롬프트 출력” 탭에 결과가 생깁니다. (첨부 파일 정보는 마커 형태로 포함됨)
5. **📋 클립보드에 복사** 버튼을 눌러 바로 붙여넣기 할 수 있습니다.
6. 복사된 내용을 GPT, Claude 등의 LLM에게 붙여넣어 바로 질문할 수 있습니다.
7. **♊ Gemini로 전송** 버튼을 누르면 생성된 프롬프트와 실제 첨부 파일 데이터를 Gemini API로 직접 전송하고, 응답을 "XML 입력" 탭과 "Summary" 탭에 자동으로 채워줍니다. ([Gemini API 직접 호출](#gemini-api-직접-호출) 참조)

### 메타 프롬프트 빌더 모드

1.  상단 메뉴 "모드" 또는 "🔄 모드 전환" 버튼을 클릭하여 "메타 프롬프트 빌더" 모드로 전환합니다.
2.  **메타 프롬프트 템플릿** 탭에 프롬프트를 감쌀 상위 템플릿을 작성합니다. (`[[user-prompt]]` 와 같이 변수 사용 가능)
3.  **메타 사용자 입력** 탭에 실제로 사용자에게 요청할 내용을 적습니다.
4.  **🚀 메타 프롬프트 생성** 버튼을 누르면 “메타 프롬프트 출력” 탭에서 결과를 볼 수 있습니다.
5.  필요 시, 추가 탭(`var-이름` 형태)을 생성하여 변수 내용을 입력하고, **🚀 최종 프롬프트 생성** 버튼 (또는 단축키 `Ctrl+Enter`)으로 변수를 치환해 완성된 형태를 얻을 수도 있습니다.
6.  **📋 메타 프롬프트 복사** 버튼을 눌러 현재 활성화된 탭(메타 프롬프트 출력 또는 최종 프롬프트)의 내용을 복사할 수 있습니다.

### 첨부 파일 관리

- 코드 강화 빌더 모드에서 사용합니다.
- 좌측 하단의 "첨부 파일" 영역에서 관리합니다.
- **📎 파일 첨부**: 파일 탐색기를 열어 이미지 또는 일반 파일을 여러 개 선택하여 목록에 추가합니다.
- **📋 클립보드 붙여넣기**: 클립보드에 복사된 이미지 또는 파일 경로를 목록에 추가합니다. (Pillow 라이브러리 필요)
- **➖ 선택 제거**: 목록에서 선택한 항목(들)을 제거합니다. (다중 선택 가능)
- 첨부된 파일은 "프롬프트 생성" 시 마커 형태로 포함되며, "Gemini로 전송" 시 실제 데이터가 함께 전송됩니다.
- 토큰 계산 시 첨부 파일의 데이터도 포함하여 계산됩니다 (Gemini 모델 선택 시).

### 디렉토리 트리 생성

- 코드 강화 빌더 모드에서 사용합니다.
- 우측 상단의 **🌳 트리 생성** 버튼을 누르면, 체크된 파일/폴더를 기준으로 디렉토리 구조를 텍스트 형태로 생성합니다.
- “파일 트리” 탭에서 결과를 볼 수 있습니다. LLM에 “디렉토리 구조”를 보여주어야 할 때 유용합니다.

### XML 파서 사용

- 코드 강화 빌더 모드에서 사용합니다.
- LLM이 생성한 `<code_changes>` 형식의 XML 응답을 복사합니다. (Gemini 직접 호출 시 자동으로 "XML 입력" 탭에 채워짐)
- “XML 입력” 탭에 XML 내용이 있는지 확인하고, **▶️ XML 파서 실행** 버튼을 클릭하면 해당 내용대로 프로젝트 폴더 내 파일 생성/수정/삭제가 일괄 수행됩니다. (별도 확인 없이 바로 실행되므로 주의!)
- XML 내용 주변의 Markdown 코드 블록(```xml ... ```)은 자동으로 제거됩니다.
- 결과 요약은 팝업으로 확인할 수 있습니다.

### 템플릿/상태 관리

- 좌측 하단의 "리소스 관리" 영역에서 관리합니다.
- **리소스 타입 선택**: "프롬프트" 또는 "상태"를 선택합니다.
- **프롬프트**: System/User 프롬프트 템플릿(`.md` 파일)을 관리합니다.
  - 목록에서 더블 클릭하여 해당 탭(시스템/사용자)에 불러올 수 있습니다.
  - 현재 탭 내용을 새 템플릿으로 저장하거나, 기존 템플릿을 업데이트/삭제할 수 있습니다.
- **상태**: 현재 프로그램 상태(선택된 파일, 프롬프트 내용, 선택된 LLM/모델명, 첨부 파일 목록 등)를 `.json` 파일로 관리합니다.
  - 작업을 중단했다가 나중에 이어서 할 때 유용합니다.
  - **"⏪ 마지막 작업 불러오기" 버튼**: 상단에 위치하며, 클릭 시 기본 저장된 상태(`default.json`)를 불러옵니다. (프로젝트 폴더, 사용자 프롬프트, 첨부 파일, **체크된 파일/폴더 목록** 복원)
  - 상태 저장/불러오기, 모든 상태 백업/복원 기능을 제공합니다. (상태 메뉴 또는 리소스 관리 영역 버튼 사용)
  - 상태 파일은 `resources/status/` 폴더에 저장됩니다.

### 토큰 수 계산

- 프로그램 하단 상태 표시줄에서 LLM 모델(Gemini, Claude, GPT)을 선택하고, 사용할 정확한 모델명을 입력할 수 있습니다. (모델 목록은 DB에서 로드)
- 텍스트 탭 내용이 변경되거나 첨부 파일이 변경될 때마다 선택된 모델 기준으로 토큰 수를 자동으로 계산하여 보여줍니다. (API 호출 필요 시 약간의 지연 발생 가능)
- **GPT**: `tiktoken` 라이브러리를 사용하여 로컬에서 계산합니다. (o200k_base 인코딩 기준, 텍스트만 계산)
- **Gemini**: Google Generative AI API (`count_tokens`)를 호출하여 계산합니다. **텍스트와 첨부 파일(이미지/파일)을 포함한 멀티모달 입력**의 토큰 수를 계산합니다.
  - **사전 설정**: **데이터베이스 `api_keys` 테이블**에 유효한 Gemini API 키가 `provider='google'`, `is_active=TRUE`로 설정되어 있어야 합니다.
- **Claude**: Anthropic API (`messages.count_tokens`)를 호출하여 계산합니다. (현재 구현은 텍스트만 계산)
  - **사전 설정**: **데이터베이스 `api_keys` 테이블**에 유효한 Anthropic API 키가 `provider='anthropic'`, `is_active=TRUE`로 설정되어 있어야 합니다.
- **모델명 저장**: 상태 표시줄에서 입력된 모델명은 DB에 자동으로 저장되지 않습니다. 기본 모델명을 변경하려면 DB를 직접 수정해야 합니다.
- **오류 처리**: API 키 누락/오류, 네트워크 문제 등으로 API 호출 실패 시 상태 표시줄에 "토큰 계산 오류" 메시지가 표시됩니다. 터미널/콘솔의 상세 오류 메시지를 확인하세요.

### Gemini API 직접 호출

- 코드 강화 빌더 모드에서 사용합니다.
- **♊ Gemini로 전송** 버튼을 클릭하면 "프롬프트 출력" 탭의 내용과 "첨부 파일" 목록의 실제 데이터를 함께 Gemini API로 전송합니다.
- **사전 설정**:
    - **데이터베이스 `api_keys` 테이블**에 유효한 Gemini API 키가 `provider='google'`, `is_active=TRUE`로 설정되어 있어야 합니다.
    - 상태 표시줄에서 사용할 Gemini 모델명 선택/입력 (기본값은 DB에서 로드).
- **Gemini 파라미터 제어**: 상태 표시줄에서 Temperature, Thinking, Budget, Search 옵션을 직접 제어할 수 있습니다. **단, 이 변경 사항은 현재 세션에만 적용되며 DB에 저장되지 않습니다.** (DB 설정을 따름)
- **응답 처리**:
    - API 호출은 백그라운드 스레드(LangGraph Worker)에서 비동기적으로 처리됩니다.
    - 성공 시, 응답은 자동으로 파싱되어 "XML 입력" 탭과 "Summary" 탭에 표시됩니다.
    - 오류 발생 시, 오류 메시지가 팝업으로 표시됩니다. (API 응답 관련 문제는 Summary 탭에 상세 내용 표시)

### 환경 설정

- 상단 메뉴 **"환경 설정"** > "환경 설정 열기..."를 선택하여 설정 다이얼로그를 엽니다.
- **주의**: 이 다이얼로그는 **데이터베이스(`application_config` 테이블)**에 저장된 설정을 **읽기 전용**으로 보여줍니다. 설정을 변경하려면 데이터베이스를 직접 수정해야 합니다.
- **표시 항목**:
  - 기본 시스템 프롬프트 경로
  - LLM 기본 모델명 (Gemini, Claude, GPT)
  - API 키 (마스킹 처리)
  - 파일 필터링 규칙 (허용 확장자, 제외 폴더/파일, 기본 무시 목록)
- **.gitignore 편집 (현재 프로젝트)**: 이 기능은 여전히 사용 가능합니다. 현재 선택된 프로젝트 폴더의 `.gitignore` 파일을 직접 편집하고 저장할 수 있습니다. 저장 시 파일 트리 필터가 즉시 업데이트됩니다.

---

## 개발 환경 설정 (리팩토링)

리팩토링 작업 및 개발 기여를 위한 환경 설정입니다.

1.  **Python 버전**: Python 3.12 이상
2.  **데이터베이스**: PostgreSQL 설정 및 `docs/duck_agent_2025-04-25_112248.sql` 스키마/데이터 로드 필요.
3.  **패키지 관리**: `uv` 사용 권장 (`pip install uv`)
4.  **가상 환경**:
    - 생성: `uv venv`
    - 활성화: (OS별 스크립트 실행 - 예: `.venv\Scripts\activate` on Windows)
5.  **의존성 설치**:
    - 기본: `uv pip install -r requirements.txt` (Pillow, LangGraph, psycopg2-binary 등 포함)
    - 개발/테스트: `uv pip install -r requirements-dev.txt`
6.  **코드 실행**: `uv run python main.py` 또는 `python main.py`
7.  **테스트 실행**: `uv run pytest tests/` (테스트 코드 추가 예정)
8.  **타입 체크**: `uv run mypy src/ tests/`
9.  **린팅/포매팅**:
    - 체크: `uv run ruff check .`
    - 포맷: `uv run black .` , `uv run ruff format .`
10. **프로젝트 구조**:
    - 모든 소스 코드는 `src/` 디렉토리 하위에 위치합니다 (`core`, `ui`, `utils` 패키지 포함).
    - 테스트 코드는 `tests/` 디렉토리 하위에 위치합니다.
    - **설정**: PostgreSQL 데이터베이스(`duck_agent`)의 `application_config`, `api_keys` 테이블에서 로드됩니다. (`src/config.yml` 파일은 DB 초기화 시 참조)
    - Pydantic 모델은 `src/core/pydantic_models/` 에 정의됩니다.
    - 핵심 로직 서비스는 `src/core/services/` 에 위치합니다 (`DbService` 추가).
    - UI 컨트롤러는 `src/ui/controllers/` 에 위치합니다.
    - UI 위젯/모델/설정 코드는 `src/ui/` 하위에 분리되어 있습니다.

---

## 기타 자주 묻는 질문 (FAQ)

1.  **파일이 많으면 프로그램이 느려지나요?**
    - 파일 트리를 표시하는 데 시간이 걸릴 수 있지만, 프롬프트 생성 시에는 체크된 파일만 처리하므로 필요한 파일만 선택하면 성능에 큰 영향은 없습니다. `.gitignore` 및 DB 설정의 필터링 규칙을 활용하여 불필요한 파일/폴더를 숨길 수 있습니다.
2.  **토큰 계산이 정확한가요?**
    - **GPT**: `tiktoken` 라이브러리를 통해 로컬에서 계산하며, 비교적 정확한 추정치를 제공합니다. (텍스트만)
    - **Claude**: Anthropic API를 호출하여 계산하므로 정확합니다. 단, DB에 API 키 설정이 필요하며 현재 구현은 텍스트만 계산합니다.
    - **Gemini**: Google Generative AI API를 호출하여 계산하므로 가장 정확하며, **텍스트와 첨부 파일(이미지/파일)을 모두 포함**하여 계산합니다. DB에 API 키 설정이 필요합니다.
    - API 호출 실패 시 계산이 불가능하며 상태 표시줄에 오류 메시지가 표시됩니다.
3.  **기본 시스템 프롬프트 지정은 어떻게 하나요?**
    - PostgreSQL 데이터베이스의 `application_config` 테이블에서 `profile_name='default'`인 행의 `default_system_prompt` 컬럼 값을 수정해야 합니다. GUI에서는 경로 확인/복사만 가능합니다.
4.  **메타 프롬프트 빌더는 언제 사용하나요?**
    - 이미 잘 작성된 프롬프트(예: 특정 역할 수행 지침)를 다른 목적의 프롬프트 템플릿으로 감싸서 재사용하거나 변형해야 할 때 유용합니다.
5.  **Gemini/Claude 토큰 계산 또는 Gemini 직접 전송이 안 돼요.**
    - [토큰 수 계산](#토큰-수-계산) 및 [Gemini API 직접 호출](#gemini-api-직접-호출) 섹션의 사전 설정 부분을 확인하세요.
    - PostgreSQL 데이터베이스의 `api_keys` 테이블에 해당 provider의 API 키가 `is_active=TRUE`로 올바르게 입력되었는지 다시 확인하세요.
    - 인터넷 연결 상태 및 DB 연결 상태를 확인하세요.
    - 터미널/콘솔에 출력되는 상세 오류 메시지를 확인하여 문제를 진단하세요 (예: `INVALID_API_KEY`, `RateLimitError` 등). Gemini API 호출 오류 시에는 "Summary" 탭에도 상세 오류 내용이 표시될 수 있습니다.
6.  **이미지 첨부는 어떻게 하나요?**
    - 좌측 하단 "첨부 파일" 영역의 "📎 파일 첨부" 버튼으로 이미지 파일을 직접 선택하거나, 이미지 파일을 복사한 후 "📋 클립보드 붙여넣기" 버튼을 사용하세요. (Pillow 라이브러리 설치 필요)
7.  **환경 설정을 변경하고 싶어요.**
    - API 키, 기본 모델명, 필터링 규칙 등 대부분의 설정은 PostgreSQL 데이터베이스(`application_config`, `api_keys` 테이블)를 직접 수정해야 합니다. GUI의 "환경 설정" 메뉴는 현재 설정을 확인하는 용도입니다. `.gitignore` 파일만 GUI에서 편집/저장이 가능합니다.
8.  **"마지막 작업 불러오기" 버튼은 무엇인가요?**
    - 클릭 시 `resources/status/default.json` 파일에 저장된 마지막 기본 상태를 불러옵니다. 프로그램을 종료했다가 다시 시작했을 때 이전 작업(프로젝트 폴더, 사용자 프롬프트, 첨부 파일, **체크된 파일/폴더 목록**)을 빠르게 복원하는 데 사용됩니다. "상태" 메뉴의 "상태 불러오기(기본)"와 동일한 기능입니다.

---

## 문의

- 사용 중에 궁금한 점이나 버그가 있다면 이슈로 남겨주세요.
- 감사합니다!

